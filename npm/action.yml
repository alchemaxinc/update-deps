name: 'Update NPM Dependencies'

description: 'Update NPM dependencies using npm-check-updates'

inputs:
  token:
    required: false
    description: 'GitHub token'
    default: ${{ github.token }}

  base-branch:
    required: true
    description: 'Base branch for PR'
    default: 'main'

  branch-prefix:
    required: false
    description: 'Branch prefix'
    default: 'update-dependencies'

  pr-title:
    required: false
    description: 'Title for the pull request'
    default: 'Update NPM Dependencies'

  commit-message:
    required: false
    description: 'The commit message for the update'
    default: 'Update NPM dependencies'

  excluded-packages:
    required: false
    description: 'Packages to exclude from updates, in a comma-separated list format'

  relock:
    required: false
    description: 'Whether package-lock.json should be regenerated, even if no other updates are available'
    default: 'false'

  auto-merge:
    required: false
    description: 'Whether a successful PR should be automatically merged'
    default: 'false'

  dry-run:
    required: false
    description: 'Run without creating a PR (for testing purposes)'
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Checkout and setup
      if: inputs.dry-run != 'true'
      uses: alchemaxinc/composite-toolbox/checkout-and-setup@v1
      with:
        token: ${{ inputs.token }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        cache: 'npm'
        node-version-file: '.nvmrc'

    - name: Cache npm-check-updates
      id: cache-ncu
      uses: actions/cache@v4
      with:
        path: ~/.npm-global
        key: npm-ncu-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          npm-ncu-${{ runner.os }}-

    - name: Install npm-check-updates
      if: steps.cache-ncu.outputs.cache-hit != 'true'
      shell: bash
      run: |
        npm config set prefix '~/.npm-global'
        export PATH=~/.npm-global/bin:$PATH
        npm install -g npm-check-updates

    - name: Update dependencies
      shell: bash
      run: |
        export PATH=~/.npm-global/bin:$PATH

        # Capture updates from ncu (it outputs lines like "package  1.0.0  →  2.0.0")
        if [ -n "${{ inputs.excluded-packages }}" ]; then
          ncu_output=$(ncu --reject "${{ inputs.excluded-packages }}" 2>/dev/null || true)
          ncu -u --reject "${{ inputs.excluded-packages }}"
        else
          ncu_output=$(ncu 2>/dev/null || true)
          ncu -u
        fi

        # Parse ncu output and emit notices for each updated package
        echo "$ncu_output" | grep -E '^\s*\S+\s+\S+\s+→\s+\S+' | while read -r line; do
          pkg=$(echo "$line" | awk '{print $1}')
          old_ver=$(echo "$line" | awk '{print $2}')
          new_ver=$(echo "$line" | awk '{print $4}')
          if [ -n "$pkg" ] && [ -n "$old_ver" ] && [ -n "$new_ver" ]; then
            echo "::notice::Updated $pkg from $old_ver to $new_ver"
          fi
        done

        if [ "${{ inputs.relock }}" = "true" ]; then
          rm -f package-lock.json
        fi
        npm install

    - name: Check for changes
      id: check_changes
      if: inputs.dry-run != 'true'
      uses: alchemaxinc/composite-toolbox/check-changes@v1
      with:
        files: 'package.json package-lock.json'

    - name: Create Pull Request
      id: open-pr
      if: inputs.dry-run != 'true' && steps.check_changes.outputs.has_changes == 'true'
      uses: alchemaxinc/composite-toolbox/create-pr@v1
      with:
        token: ${{ inputs.token }}
        base-branch: ${{ inputs.base-branch }}
        branch-prefix: ${{ inputs.branch-prefix }}
        files: 'package.json package-lock.json'
        commit-message: ${{ inputs.commit-message }}
        pr-title: ${{ inputs.pr-title }}
        pr-body: |
          # :arrows_counterclockwise: NPM Dependencies Update

          This pull request automatically updates NPM dependencies to their latest versions.

          ## :warning: Important Notes

          - :robot: This PR was **automatically generated**
          - :mag: Please **review all changes** carefully before merging
          - :test_tube: Ensure all tests pass and functionality works as expected
          - :books: Check for any breaking changes in the updated dependencies

          ## :rocket: Next Steps

          1. Review the dependency changes above
          2. Run tests locally or wait for CI/CD to complete
          3. Merge when everything looks good!

          ---

          *Generated by the NPM Dependencies Update action* :sparkles:

    - name: Auto-merge Pull Request
      if: inputs.dry-run != 'true' && inputs.auto-merge == 'true' && steps.open-pr.outcome == 'success'
      uses: alchemaxinc/composite-toolbox/merge-pr@v1
      with:
        token: ${{ inputs.token }}
        merge-method: 'squash'
        pull-request-number: ${{ steps.open-pr.outputs.pr_number }}
